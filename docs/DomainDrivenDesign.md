# Domain-Driven Design (DDD) для системы WebSocket

## 1. Моделирование предметной области

### Предметная область (Domain)

В контексте системы WebSocket, предметная область охватывает следующие ключевые аспекты:

- Управление WebSocket-соединениями
- Маршрутизация сообщений
- Управление каналами
- Безопасность
- Обработка сообщений и событий

Основные бизнес-процессы включают:

- Обработка и маршрутизация сообщений
- Управление доступом к каналам
- Мониторинг активности системы
- Ограничение частоты запросов
- Управление состоянием присутствия пользователей

### Выделение доменных слоев

1. **Доменный слой (Domain Layer)**:
   Содержит бизнес-логику и модели предметной области, такие как управление пользователями, каналами и сообщениями.

2. **Слой приложения (Application Layer)**:
   Обрабатывает запросы от WebSocket, взаимодействует с доменным слоем для выполнения бизнес-логики и управления данными.

3. **Инфраструктурный слой (Infrastructure Layer)**:
   Реализует технические детали, такие как взаимодействие с базой данных, кэширование и интеграцию с внешними системами.

## 2. Основные компоненты системы в терминах DDD

### Сущности (Entities)

- **Пользователь (User)**:
  Представляет клиента системы. Включает уникальный идентификатор, имя, статус (онлайн/оффлайн) и аутентификационные данные.

- **Сообщение (Message)**:
  Представляет сообщение в чате. Содержит уникальный идентификатор, текст сообщения, метку времени и ссылку на отправителя (пользователя).

- **Канал (Channel)**:
  Представляет канал для обмена сообщениями. Включает уникальный идентификатор, тип канала (публичный, приватный, присутствия) и список подписчиков.

### Значения (Value Objects)

- **Адрес (Address)**:
  Представляет физический или виртуальный адрес, например, адрес для отправки сообщений. Это значение неизменно и используется для идентификации канала или пользователя.

- **Токен (Token)**:
  Значение, представляющее собой токен аутентификации или авторизации. Используется для проверки прав доступа к приватным каналам.

### Агрегаты (Aggregates)

- **Агрегат "Чат-комната" (ChatRoom)**:
  Включает сущности "Канал" и связанные с ним "Сообщения" и "Пользователи". Управляет состоянием канала, добавлением сообщений и пользователями.

- **Агрегат "Пользовательский сеанс" (UserSession)**:
  Включает сущности "Пользователь" и связанные с ним "Сообщения" и "Каналы". Управляет состоянием сеанса пользователя, подписками на каналы и историей сообщений.

### Репозитории (Repositories)

- **Репозиторий пользователей (UserRepository)**:
  Хранит и извлекает данные о пользователях, предоставляет доступ к информации о пользователе по уникальному идентификатору.

- **Репозиторий сообщений (MessageRepository)**:
  Хранит и извлекает сообщения, позволяет получать сообщения по каналам и пользователям.

- **Репозиторий каналов (ChannelRepository)**:
  Хранит и извлекает данные о каналах, управляет подписками и распределением сообщений.

### Сервисы домена (Domain Services)

- **Сервис маршрутизации сообщений (MessageRoutingService)**:
  Обрабатывает маршрутизацию сообщений, направляя их в соответствующие каналы и пользователям.

- **Сервис аутентификации и авторизации (AuthenticationService)**:
  Отвечает за проверку подлинности токенов и контроль доступа к приватным каналам.

- **Сервис управления каналами (ChannelManagementService)**:
  Управляет созданием и настройкой каналов, а также подписками пользователей.

- **Сервис ограничения частоты запросов (RateLimitingService)**:
  Внедряет ограничения на частоту запросов для предотвращения злоупотреблений.

### Анти-коррупционные слои (Anti-Corruption Layers)

Пример: Если интегрируется с внешним API для аутентификации, анти-коррупционный слой может преобразовывать данные и бизнес-логику внешней системы в формат, понятный вашему домену.

## 3. Контексты и взаимодействие

### Контексты (Bounded Contexts)

- **Контекст "Чат-комнаты" (Chat Context)**:
  Управляет функциональностью чат-комнат, включая каналы и сообщения. Взаимодействует с другими контекстами через интерфейсы и службы.

- **Контекст "Профили пользователей" (User Profile Context)**:
  Управляет данными о пользователях и их статусами. Взаимодействует с контекстом "Чат-комнаты" для управления подписками и состоянием сеансов.

### Взаимодействие компонентов

1. **IoServer** принимает входящие соединения и передает их в **HttpServer**, который устанавливает WebSocket-соединение и направляет в **WsServer**.

2. **WsServer** взаимодействует с **MessageRoutingService** для маршрутизации сообщений по каналам и пользователям. Использует **WebSocketRouter** для определения целевых каналов и направления сообщений.

3. **ClientManager** отслеживает активные соединения и взаимодействует с **UserRepository** и **ChannelRepository** для управления состоянием соединений и подписок.

4. **SecurityModule** обеспечивает аутентификацию и авторизацию, используя **AuthenticationService** для проверки токенов и доступа к каналам.

5. **BroadcastingModule** отправляет сообщения всем подписчикам определенного канала. Взаимодействует с **ChannelManager** для распределения сообщений по подписанным пользователям.

6. **MonitoringModule** предоставляет информацию о состоянии системы и помогает в отладке, взаимодействуя с **Redis** для кэширования данных и сбора метрик. **MonitoringModule** также собирает и анализирует метрики о WebSocket-соединениях и их активности.

7. **Queue** и **Redis** используются для управления асинхронными задачами и межпроцессного взаимодействия. **Queue** обрабатывает задачи, связанные с обработкой сообщений, а **Redis** обеспечивает кэширование и IPC.

8. **WebSocketRouter** и **ChannelManager** взаимодействуют с **ChannelRepository** для создания и управления каналами, включая публичные, приватные и каналы присутствия. Обеспечивает маршрутизацию сообщений в соответствующие каналы.

9. **RateLimiter** внедряется в **ChannelManager** и **WebSocketRouter** для контроля частоты запросов от клиентов, предотвращая перегрузку и злоупотребления.

10. **WebSocketHandlers** обрабатывают входящие сообщения и события, применяя логику для различных типов сообщений и событий. Взаимодействует с **ChannelManager** для обработки сообщений и управления каналами присутствия.

11. **ChannelAuthorization** управляет доступом пользователей к каналам, проверяя права доступа перед тем, как разрешить подключение или отправку сообщений в приватные каналы.

## Заключение

Использование DDD в системе WebSocket позволяет создать четко структурированную модель, которая точно отражает бизнес-логику и взаимодействие между компонентами системы. Определение сущностей, значений, агрегатов и контекстов помогает в организации и проектировании системы, что делает её масштабируемой, безопасной и легко поддерживаемой.
